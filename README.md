*Developed by Mina Hafzalla*

# Auto Trimming of Quoted Email Text for WHMCS
This workaround addresses an issue within [WHMCS (WHM Complete Solution)](https://www.whmcs.com/members/aff.php?aff=12390){:target="_blank"} where quoted text are not getting stripped when users reply to support tickets through email. WHMCS imports replies to the ticket system along with the original message when a user replies to an existing ticket directly via their email. This behavior might confuse users and it makes the whole ticket view unprofessional. Fortunately, I have developed a client-side regex code that goes into the Smarty view ticket template file and removes these quoted text. It supports most major email providers: Gmail, Outlook, Yahoo!, iCloud Mail and cPanel Webmail.


# Sample Ticket Reply
```
Lorem ipsum vivamus facilisis sociosqu porta bibendum maecenas.

Regards,
John Smith

On Tuesday, November 28, 2017, John Smith <example@domain.com> wrote:
Lorem ipsum tristique at ut morbi vitae felis gravida tellus, quisque hendrerit auctor curabitur diam nibh per nunc tristique, leo curabitur suspendisse nec class mauris tempus donec.
```

# How it works
Email providers start their email quoted text with a timestamp. Each provider has a different timestamp pattern and format; our regex code works by detecting and matching these timestamps generated by email providers, strip them and any line after, thus leaving only the reply without quoting the original message (history). 

# Installation
1.	Browse to the directory /whmcs/templates/six/
2.	Open the file viewticket.tpl
3.	Find the variable `{$reply.message}`
4.	Replace `{$reply.message}` with the following code.
```
<!-- Developed by Mina Hafzalla -->
{$reply.message|regex_replace:"/(.*?)(On|Date:|&gt;|&gt; On|&gt; Date:)( ((Sun|Mon|Tue|Wed|Thu|Fri|Sat|Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday),|([1-9]|[12][0-9]|3[01])) ((Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)|([1-9]|[12][0-9]|3[01])) (([1-9]|[12][0-9]|3[01]),|(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)|([1-9][0-9][0-9][0-9]|[0-9][1-9][0-9][0-9]|[0-9][0-9][1-9][0-9]|[0-9][0-9][0-9][1-9])|([1-9][0-9][0-9][0-9]|[0-9][1-9][0-9][0-9]|[0-9][0-9][1-9][0-9]|[0-9][0-9][0-9][1-9]),) ((((at ([0-2]\d)(\.|:)([0-5]\d),)|([1-9][0-9][0-9][0-9]|[0-9][1-9][0-9][0-9]|[0-9][0-9][1-9][0-9]|[0-9][0-9][0-9][1-9]) (at (1[012]|[1-9]):[0-5][0-9](\\s)?(?i) (AM|PM)|(1[012]|[1-9]):[0-5][0-9](\\s)?(?i) (AM|PM),|([0-9]+):([0-5][0-9]|60):([0-5][0-9]|60))|([1-9][0-9][0-9][0-9]|[0-9][1-9][0-9][0-9]|[0-9][0-9][1-9][0-9]|[0-9][0-9][0-9][1-9]),))|(at (1[012]|[1-9]):[0-5][0-9](\\s)?(?i) (am|pm),))| (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ([1-9]|[12][0-9]|3[01]), (([1-9][0-9][0-9][0-9]|[0-9][1-9][0-9][0-9]|[0-9][0-9][1-9][0-9]|[0-9][0-9][0-9][1-9]),|([1-9][0-9][0-9][0-9]|[0-9][1-9][0-9][0-9]|[0-9][0-9][1-9][0-9]|[0-9][0-9][0-9][1-9])) at ((1[012]|0[1-9]):[0-5][0-9](\\s)?(?i)|(1[012]|[1-9]):[0-5][0-9](\\s)?(?i))(am|pm|AM|PM),)[.|\n|\W|\w]*/":"\\1"}
```
5. Save the file and upload it to your server.

# Compatibility
## Software
This regex code is compatible with WHMCS versions 6.x.x and 7.x.x

## Samples of Supported Formats
### Gmail:
On Tue, Dec 26, 2017 at 6:57 PM,

On 2 December 2017 at 04:14,

On Tuesday, November 28, 2017,

On Feb 27, 2017 9:49 AM,

### Yahoo!:
On Tuesday, December 26, 2017 6:49 AM,

### Outlook:
Date: Wed, 27 Dec 2017 15:13:38

### iCloud Mail:
On Dec 27, 2017, at 05:17 pm,

### cPanel Webmail:
\> On Nov 30, 2017, at 5:05 AM,

\> On 1 Dec 2017, at 1:11 am,

## Request New Format
Leave a comment or send me a message at  mina@netmoly.com and Iâ€™ll be happy to modify the code to support your requested format.

*Note: This code can also be used for the Admin View Ticket template file.*
